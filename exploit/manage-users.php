
<?php
require('../config/autoload.php');

if(!isset($_SESSION['id']) || ($_SESSION['authorized'] !=1)){
	echo "pas de variable session";
	header('Location:'. DIR_NOSESSION);
}
//------------------------------------------------------
//			css dynamique
//----------------------------------------------------------------
$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."css/".$pageCss.".css";

include('../Class/PiloteManager.php');
// on regarde si on trouve ce pseudo dans la table chrono
function pseudoInChrono($pdo, $pseudo){
	$req=$pdo->prepare("SELECT * FROM chronos WHERE pseudo LIKE :pseudo");
	$req->execute([
		':pseudo'	=>$pseudo
	]);
	$data=$req->fetchAll(PDO::FETCH_ASSOC);
	if(empty($data)){
		return "";
	}
	return $data;
}

$piloteManager=new PiloteManager($pdo);
$pendingList=$piloteManager->getListPilotes(['authorized=0']);
$activeList=$piloteManager->getListPilotes(['authorized=1']);




//------------------------------------------------------
//			FONCTION
//------------------------------------------------------

 //------------------------------------------------------
//			DECLARATIONS
//------------------------------------------------------
$errors=[];
$success=[];
//------------------------------------------------------
//			VIEW
//------------------------------------------------------
include('../view/_head.php');

?>
<!--********************************
DEBUT CONTENU CONTAINER
*********************************-->
<div class="container-fluid">
	<div class="row">
		<div class="col pt-3  mb-3 text-center">
			<h1 class="underline-anim">Administration utilisateurs</h1>			
		</div>
	</div>

	<div class="row">
		<div class="col">
			<?php
			include('../view/_errors.php');
			?>
		</div>
	</div>

	<div class="row mt-5 mb-3">
		<div class="col-md-1"></div>
		<div class="col">
			<h2>Comptes utilisateurs en attente de validation</h2>
		</div>
	</div>
	<div class="row justify-content-center">
		
		<div class="col-auto">

			<table class="table table-sm border border-light fit">
				<thead >
					<tr>
						<th class="fit">Pseudo</th>
						<th class="fit">Chronos trouvés</th>
						<th class="fit">Actions</th>
					</tr>
				</thead>
				<tbody>


					<?php foreach ($pendingList as $pending): ?>
						<tr>
							<td class="fit"><?= $pending['pseudo']; ?></td>
							<td class="fit">
								<?php if (!empty(pseudoInChrono($pdo, $pending['pseudo']))): ?>
									<div class="text-primary">OUI</div>
									<?php else: ?>
										NON
									<?php endif ?>
								</td>
								<td class="fit">
									<div class="btn btn-primary">Valider</div>

									<div class="btn btn-danger">Refuser</div>	
								</td>
							</tr>
						<?php endforeach ?>

					</tbody>
				</table>
			</div>
			

		</div>
		<div class="row  mt-5 mb-3">
		<div class="col-md-1"></div>

			<div class="col">
				<h2>Comptes utilisateurs validés</h2>
			</div>
		</div>


		<!-- ./container -->
	</div>

	<?php
	require '../view/_footer.php';
	?>